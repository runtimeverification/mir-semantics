name: Example Test w/ Published Container

on:
  pull_request:
    branches:
      - master
permissions:
  packages: write

jobs:
  publish-test-container:
    runs-on: ubuntu-latest
    outputs:
      container-image: ${{ steps.set-container-name .outputs.container-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3.10.0
      - name: Set K_VERSION
        run: |
          export K_VERSION=$(cat deps/k_release)
      - name: Set Container Name
        id: set-container-name
        run: |
          echo "container-name=ghcr.io/runtimeverification/mir-semantics/kmir:ubuntu-jammy-${K_VERSION}" >> $GITHUB_OUTPUT
      - name: Build Kmir Container
        id: build-container
        run: |
          docker buildx build --build-arg K_VERSION=${K_VERSION} -f Dockerfile.kmir --platform linux/amd64 -t ${{ steps.set-container-name.outputs.container-name }} --push .

  test:
    runs-on: ubuntu-latest
    needs: publish-test-container
    container:
      image: ${{ needs.publish-test-container.outputs.container-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: sample-challenge-11-proofs  
      - name: Kmir Prove
        run: |
          cd rust-verification-proofs/unchecked_add
          kmir prove run  $PWD/unchecked-op-spec.k --proof-dir $PWD/proof 
