KMIR &mdash; [MIR](https://rustc-dev-guide.rust-lang.org/mir/index.html)'s Operational Semantics in [K](http://github.com/kframework)
=============================================================

üõ†Ô∏è**Work in progress**üõ†Ô∏è

[MIR](https://rustc-dev-guide.rust-lang.org/mir/index.html) is the mid-level internal representation of Rust program in rust compiler.

The `KMIR` project defines MIR semantics formally in K and attempts build a scalable testing and verification tool for real world Rust programs. 

## Quick Start 

### Installation

-   `bash <(curl https://kframework.org/install)`: install [kup package manager].
-   `kup install kmir`: install the latest version of KMIR.

You can refer to `kup -h` for more options. For example,
-   `kup list kmir`: list available KMIR versions.
-   `kup install kmir --version 366f8fb`: install a paricular version of KMIR.

**NOTE**: The first run will take longer to fetch all the libraries and compile sources.

### Using `KMIR`

At the current stage, `KMIR` is to be used as a command-line tool. We list the main functions in the following, while users are recommended to explore the latest options using `kmir -h`or more options of a command using `kmir {cmd} -h`.

#### Parsing a MIR file:
The `kmir parse` command invokes the parser generated by K and outputs a KAST representation of MIR abstract syntax parsed from a file. 

```sh
kmir parse --definition-dir $(kbuild which llvm) demo/assert-true.mir
```
The output of this command is going to look intimidating, but it is, in fact, just a K-friendly representation of the programs abstract-syntax tree. `kmir parse` can *unparse* this representation to make it look more like the original MIR source (note the `--output pretty` at the end).

```sh
kmir parse --definition-dir $(kbuild which llvm) demo/assert-true.mir --output pretty
```

You may wounder that `--definition-dir $(kbuild which llvm)` means. Since `kmir` is just a thin Python script and does not do any heavy-lifting itself, it needs access the the K definition of MIR. The `kbuild` tool handles compiling the K code and provides a `which` command to output the path to the compiled definition, which we give to `kmir`.

#### Execute a MIR program
The `kmir run` command will interpret a MIR program according to predefined operatonal rules of `MIR`. This command invokes the LLVM interpreter generated by K and execute the MIR code in the file.

### Examples

We assume that you've run `poetry  install && poetry shell` in the `kmir/` directory and thus the `kmir` executable is available.





## Project Structure
The KMIR project comprises two major components:
- Directory `kmir/k-src`: it contains the formal definition of MIR's operational semantics as rewrite rules in K;
- Directory `kmir/src/kmir`: it implemets the `kmir` command-line tool using the [pyk](https://github.com/runtimeverification/pyk) library providing access to MIR's semantics in K. Command-line options are introduec in `kmir/README.md`.

## Build from source

### Getting source code
Using the following command to clone this repository, including its submodules:
```sh
git clone --recurse-submodules git@github.com:runtimeverification/mir-semantics.git
```

### Build `KMIR`
To work on KMIR, the following software is needed:
- The K Framework. See the [K Installation Guide](https://github.com/runtimeverification/k).
- The `poetry` tool to build and manage the Python code. See the [Poetry Installation Guide](https://python-poetry.org/docs/#installation).
- Optionally, the `rustc` Rust compiler to compiler Rust code to MIR. See the [Rust Installation Guide](https://doc.rust-lang.org/book/ch01-01-installation.html)

**Prerequsites**: `python 3.8.*`, `pip >= 20.0.2`, `poetry >= 1.3.2`.

We use the `poetry` tool to manage Python virtual environments. This step will create an environment and install the `kmir` tool via `poetry`, executing

```sh
cd kmir
make build
```

### Installation
You can further run the following commands to obtain a global installation of fresh-built `KMIR`,
```sh
pip install dist/*.whl
```

## Testing


# Working with Docker
We provide a Docker image for isolated testing, locally and in CI.

### Running integration tests with `docker`:

- From the root of the repository:
    - Build the docker image (the `./deps/k_release` file pins the K version):
    ```
    $ docker build . --build-arg K_COMMIT=$(cat ./deps/k_release) --tag mir-semantics:$(cat ./deps/k_release)
    ```
    - Run the integration tests in a container:
    ```
    $ docker run --name mir-semantics --rm -it -u user --workdir /home/user mir-semantics:$(cat ./deps/k_release) make -C kmir test-integration
    ```

Note: you may need to run the `docker` commands with `sudo`.

We use a similar workflow in CI actions defined in the `.github/` directory.


## References
- You may refer to [K tutorial](https://kframework.org/k-distribution/k-tutorial/) to learn more about using K.
- [MIR language reference](https://kframework.org/k-distribution/k-tutorial/)

